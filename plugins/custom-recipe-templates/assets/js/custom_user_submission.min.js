function isLastIngredient(thisRow){console.log("%c In isLastIngredient","background:#CCC;color:red;padding:10px;border-radius:2px"),console.log("item = "+thisRow.attr("id"));var hasGroupAfter=thisRow.next(".ingredient-group").length;console.log("next group = "+thisRow.next(".ingredient-group").prop("tagName")),console.log("has group after = "+hasGroupAfter),console.log("#recipe-ingredients tr:last");var isLastIngredient=thisRow.attr("id")==jQuery("#recipe-ingredients tr:last").attr("id");return console.log("is last ingredient = "+isLastIngredient),hasGroupAfter||isLastIngredient}function PreviewImage(id){console.log("Entering PreviewImage");var fileInput=document.getElementById("recipe_thumbnail_input_"+id);if(fileInput.files&&fileInput.files[0]){var extension=fileInput.files[0].name.split(".").pop().toLowerCase(),isSuccess;if(custom_user_submissions.fileTypes.indexOf(extension)>-1){var imgSize=fileInput.files[0].size/1024;if(console.log("File size (kB) = "+document.getElementById("recipe_thumbnail_input_"+id).files[0].size/1024),imgSize<custom_user_submissions.maxFileSize){var oFReader=new FileReader;oFReader.readAsDataURL(fileInput.files[0]),oFReader.onload=function(oFREvent){document.getElementById("recipe_thumbnail_preview_"+id).src=oFREvent.target.result,jQuery("#recipe_instruction_"+id+" .instruction-image").removeClass("nodisplay")}}else jQuery(fileInput).val(""),alert(custom_user_submissions.fileTooBig)}else jQuery(fileInput).val(""),alert(custom_user_submissions.wrongFileType)}}function addRecipeIngredientGroup(){var last_group=jQuery("#recipe-ingredients tr.ingredient-group-stub"),last_row=jQuery("#recipe-ingredients tr:last"),clone_group;last_group.clone(!0).insertAfter(last_row).removeClass("ingredient-group-stub").addClass("ingredient-group"),jQuery(".ingredient-groups-disabled").hide(),jQuery(".ingredient-groups-enabled").show(),calculateIngredientGroups()}function calculateIngredientGroups(){1==jQuery(".ingredient-group").length?(jQuery("#recipe-ingredients .ingredient .ingredients_group").val(""),jQuery(".ingredient-groups-disabled").show(),jQuery(".ingredient-groups-enabled").hide()):(jQuery("#recipe-ingredients tr.ingredient").each(function(i,row){var group=jQuery(row).prevAll(".ingredient-group:first").find(".ingredient-group-label").val();void 0===group&&(group=jQuery(".ingredient-group-first").find(".ingredient-group-label").val()),jQuery(row).find(".ingredients_group").val(group)}),jQuery(".ingredient-groups-disabled").hide(),jQuery(".ingredient-groups-enabled").show())}function addRecipeInstructionGroup(){var last_group=jQuery("#recipe-instructions tr.instruction-group-stub"),last_row=jQuery("#recipe-instructions tr:last"),clone_group;last_group.clone(!0).insertAfter(last_row).removeClass("instruction-group-stub").addClass("instruction-group"),jQuery(".instruction-groups-disabled").hide(),jQuery(".instruction-groups-enabled").show(),calculateInstructionGroups()}function calculateInstructionGroups(){1==jQuery(".instruction-group").length?(jQuery("#recipe-instructions .instruction .instructions_group").val(""),jQuery(".instruction-groups-disabled").show(),jQuery(".instruction-groups-enabled").hide()):(jQuery("#recipe-instructions tr.instruction").each(function(i,row){var group=jQuery(row).prevAll(".instruction-group:first").find(".instruction-group-label").val();void 0===group&&(group=jQuery(".instruction-group-first").find(".instruction-group-label").val()),jQuery(row).find(".instructions_group").val(group)}),jQuery(".instruction-groups-disabled").hide(),jQuery(".instruction-groups-enabled").show())}function updateIngredientIndex(){jQuery("#recipe-ingredients tr.ingredient").each(function(i){jQuery(this).find("input, textarea").attr("name",function(index,name){return name.replace(/(\d+)/,i)}).attr("id",function(index,id){return id.replace(/(\d+)/,i)})})}function addRecipeIngredient(currentIngredient){var nbr_ingredients=jQuery("#recipe-ingredients tr.ingredient").length,last_row=jQuery("#recipe-ingredients tr:last");currentIngredient&&(last_row=currentIngredient);var clone_ingredient=last_row.clone(!0);clone_ingredient.find("td.ingredient-preview").html(""),clone_ingredient.insertAfter(last_row).find("input, select, textarea").val("").attr("name",function(index,name){return name.replace(/(\d+)/,nbr_ingredients)}).attr("id",function(index,id){return id.replace(/(\d+)/,nbr_ingredients)}).closest("tr.ingredient").attr("id",function(index,id){return id.replace(/(\d+)/,nbr_ingredients)}),clone_ingredient.find("span.ingredients-delete").show(),jQuery("#recipe-ingredients tr:last .ingredients_amount").focus(),calculateIngredientGroups()}function addRecipeInstruction(){var nbr_instructions=jQuery("#recipe-instructions tr.instruction").length,new_instruction=jQuery("#recipe-instructions tr.instruction:last").clone(!0);new_instruction.insertAfter("#recipe-instructions tr:last").find("textarea").val("").attr("name",function(index,name){return name.replace(/(\d+)/,nbr_instructions)}).attr("id",function(index,id){return id.replace(/(\d+)/,nbr_instructions)}),new_instruction.find("input").val(""),new_instruction.find(".instruction-image").addClass("nodisplay"),new_instruction.find(".recipe_instructions_image").attr("name",function(index,name){return name.replace(/(\d+)/,nbr_instructions)}).attr("id",function(index,id){return id.replace(/(\d+)/,nbr_instructions)}).val(null),new_instruction.find(".recipe_instructions_thumbnail").attr("id",function(index,id){return id.replace(/(\d+)/,nbr_instructions)}).attr("src",custom_user_submissions.placeholder),new_instruction.find(".instructions_group").attr("name",function(index,name){return name.replace(/(\d+)/,nbr_instructions)}).attr("id",function(index,id){return id.replace(/(\d+)/,nbr_instructions)}),new_instruction.find("span.instructions-delete").show(),jQuery("#recipe-instructions tr:last textarea").focus(),calculateInstructionGroups()}function updateInstructionIndex(){jQuery("#recipe-instructions tr.instruction").each(function(i){jQuery(this).find("textarea").attr("name",function(index,name){return name.replace(/(\d+)/,i)}).attr("id",function(index,id){return id.replace(/(\d+)/,i)}),jQuery(this).find(".recipe_instructions_image").attr("name",function(index,name){return name.replace(/(\d+)/,i)}),jQuery(this).find(".instructions_group").attr("name",function(index,name){return name.replace(/(\d+)/,i)}).attr("id",function(index,id){return id.replace(/(\d+)/,i)})})}jQuery(document).ready(function(){jQuery("input.selectonfocus").focus(function(){jQuery(this).select()}),jQuery("#recipe-instructions textarea, #recipe-ingredients textarea").each(function(){console.log("Auto adjust height at startup"),jQuery(this).outerHeight(38).outerHeight(this.scrollHeight+5)}),jQuery("#recipe-instructions, #recipe-ingredients").on("input","textarea",function(){console.log("Auto adjust height on edit"),jQuery(this).outerHeight(38).outerHeight(this.scrollHeight)}),jQuery("#insert-recipe-shortcode").on("click",function(){wpurp_add_to_editor("[recipe]")}),jQuery("#insert-nutrition-shortcode").on("click",function(){wpurp_add_to_editor("[nutrition-label]")});var text_editor=jQuery("#recipe_description"),calculateIngredientGroupsTimer,calculateInstructionGroupsTimer;function wpurp_add_to_editor(text){if(!tinyMCE.activeEditor||tinyMCE.activeEditor.isHidden()){var current=text_editor.val();text_editor.val(current+text)}else tinyMCE.execCommand("mceInsertContent",!1,text)}tinymce.init({selector:"#recipe_description, #recipe_notes",theme:"modern",language:"fr_FR",statusbar:!1,menubar:!1,toolbar:"undo redo | styleselect | bold italic underline | link image | alignleft aligncenter alignright | bullist | searchreplace",plugins:"autoresize link spellchecker searchreplace placeholder lists",autoresize_bottom_margin:20,placeholder_attrs:{style:{position:"absolute",top:"5px",left:0,color:"#888","font-style":"italic",padding:"1%",width:"98%",overflow:"hidden","white-space":"pre-wrap"}}}),calculateIngredientGroups(),jQuery("#ingredients-add-group").on("click",function(e){e.preventDefault(),addRecipeIngredientGroup()}),jQuery(".ingredient-group-label").on("input",function(){window.clearTimeout(calculateIngredientGroupsTimer),calculateIngredientGroupsTimer=window.setTimeout(function(){calculateIngredientGroups()},500)}),jQuery(".ingredient-group-delete").on("click",function(){jQuery(this).parents("tr").remove(),calculateIngredientGroups()}),calculateInstructionGroups(),jQuery("#instructions-add-group").on("click",function(e){e.preventDefault(),addRecipeInstructionGroup()}),jQuery(".instruction-group-label").on("input",function(){window.clearTimeout(calculateInstructionGroupsTimer),calculateInstructionGroupsTimer=window.setTimeout(function(){calculateInstructionGroups()},500)}),jQuery("#recipe-ingredients tbody").sortable({opacity:.6,revert:!0,cursor:"move",handle:".sort-handle",update:function(){calculateIngredientGroups(),updateIngredientIndex()}}),jQuery(".ingredients-delete").on("click",function(){jQuery(this).parents("tr").remove(),updateIngredientIndex()}),jQuery("#ingredients-add").on("click",function(e){e.preventDefault(),addRecipeIngredient()}),jQuery("#recipe-ingredients").on("keydown",".ingredients_notes",function(e){var keyCode;if(console.log("%c Found keypress on "+jQuery(this).attr("class")+jQuery(this).attr("id"),"background:#CCC;color:blue"),9==(e.keyCode||e.which)&&0==e.shiftKey){var currentRow=jQuery(this).closest("tr");console.log("currentRow = "+currentRow.prop("tagName")+currentRow.attr("class")),e.preventDefault(),isLastIngredient(currentRow)?addRecipeIngredient(currentRow):(console.log("ingredient.next.focus"),currentRow.next().focus())}}),jQuery(document).on("keyup","input",function(e){if(13==e.keyCode){e.preventDefault();var inputs=jQuery(e.target).parents("form").eq(0).find(":input:visible"),idx=inputs.index(e.target);idx==inputs.length-1?inputs[0].select():(inputs[idx+1].focus(),inputs[idx+1].select())}}),jQuery("#recipe-ingredients .ingredients_amount").on("keydown",function(e){var keyCode=e.keyCode||e.which,current_ingredient=jQuery(this).closest("tr.ingredient"),current_id=current_ingredient.attr("id"),previous_ingredient;(console.log("Current ingredient : "+current_id),9==keyCode&&1==e.shiftKey)&&(e.preventDefault(),current_ingredient.prev().focus())}),jQuery("#recipe-instructions tbody").sortable({opacity:.6,revert:!0,cursor:"move",handle:".sort-handle",update:function(){calculateInstructionGroups(),updateInstructionIndex()}}),jQuery(".instructions-delete").on("click",function(){jQuery(this).parents("tr").remove(),updateInstructionIndex()}),jQuery("#instructions-add").on("click",function(e){e.preventDefault(),addRecipeInstruction()}),jQuery("#recipe-instructions .instruction:last-of-type .instruction-text").on("keydown",function(e){var keyCode;9==(e.keyCode||e.which)&&0==e.shiftKey&&(e.preventDefault(),addRecipeInstruction())}),jQuery(".recipe-image-container").on("change","input.recipe_thumbnail_image",function(){PreviewImage("")}),jQuery(".recipe-instructions-container").on("change","input.recipe_instructions_image",function(){var InstructionId,Id;PreviewImage(jQuery(this).attr("id").match(/\d+/))}),jQuery(".recipe-instructions-container").on("click",".recipe_remove_image_button",function(){console.log("Click on remove instruction image"),confirm(custom_user_submissions.deleteImage)&&(jQuery(this).prev("img").removeAttr("src"),jQuery(this).parents(".instruction").find("td.instruction-content .instruction-buttons input").val(""),jQuery(this).next("input").val(""),jQuery(this).parents(".instruction-image").addClass("nodisplay"))}),jQuery(".recipe-image-container").on("click",".recipe_remove_image_button",function(){if(console.log("Click on remove recipe image"),confirm(custom_user_submissions.deleteImage)){var prevImg=jQuery(this).prev("img");prevImg.removeAttr("src"),prevImg.addClass("nodisplay"),jQuery(this).next("input").val(""),jQuery(this).addClass("nodisplay")}})}),jQuery(".instruction-group-delete").on("click",function(){jQuery(this).parents("tr").remove(),calculateInstructionGroups()});