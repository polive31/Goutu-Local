var currentIngredientId=-1;function toggleIngredientPreview(e){if(lastIngredientId=currentIngredientId,currentIngredientId=(currentIngredientId=jQuery(e).attr("id").match(/\d+/))[0],jQuery(e).removeClass("saved new"),jQuery(e).addClass("edit"),console.log("Current ingredient : "+currentIngredientId),console.log("Last ingredient : "+lastIngredientId),lastIngredientId!=currentIngredientId&&-1!=lastIngredientId){lastIngredient=jQuery("#recipe-ingredients").find("tr#ingredient_"+lastIngredientId),console.log("Ajax call launched !");try{xhr_ingredient.abort()}catch(e){}xhr_ingredient=jQuery.ajax({url:custom_user_submissions.ajaxurl,method:"POST",data:{action:"ingredient_preview",security:custom_user_submissions.nonce,target_ingredient_id:lastIngredientId,amount:lastIngredient.find(".ingredients_amount").val(),unit:lastIngredient.find(".ingredients_unit").val(),ingredient:lastIngredient.find(".ingredients_name").val(),notes:lastIngredient.find(".ingredients_notes").val()},success:function(e){e.success?(jQuery("#recipe-ingredients").find("tr#ingredient_"+lastIngredientId+" td.ingredient-preview").html(e.data.msg),lastIngredient.removeClass("edit new"),lastIngredient.addClass("saved")):console.log("Error on Ajax call processing : "+e.data.msg)},error:function(e){console.log("Ajax call failed : "+e.msg)}})}else console.log("No row change")}function autoSuggestIngredient(e){term=e.val(),id=e.attr("id"),tax="ingredient",spinnerHTML=e.closest("td").next().children(".ajax-indicator"),spinnerHTML.css("visibility","hidden"),jQuery(e).autoComplete({minChars:3,delay:200,source:function(e,n){spinnerHTML.css("visibility","visible");try{xhr.abort()}catch(e){}xhr=jQuery.ajax({dataType:"json",url:"/wp-admin/admin-ajax.php",data:"action=get_tax_terms&tax="+tax+"&keys="+e,success:function(e){n(e),spinnerHTML.css("visibility","hidden")}})}})}function autoSuggestUnit(e){console.log("In autoSuggestUnit"),term=e.val(),jQuery(e).autoComplete({minChars:1,source:function(n,t){n=n.toLowerCase();var r=e.parents(".recipe-ingredients-container").data("units"),u=[];for(i=0;i<r.length;i++)~r[i].toLowerCase().indexOf(n)&&u.push(r[i]);t(u)}})}function PreviewImage(e){var n=new FileReader;n.readAsDataURL(document.getElementById("recipe_thumbnail_input_"+e).files[0]),n.onload=function(n){document.getElementById("instruction_thumbnail_preview_"+e).src=n.target.result}}function addRecipeIngredientGroup(){var e=jQuery("#recipe-ingredients tr.ingredient-group-stub"),n=jQuery("#recipe-ingredients tr:last");e.clone(!0).insertAfter(n).removeClass("ingredient-group-stub").addClass("ingredient-group"),jQuery(".ingredient-groups-disabled").hide(),jQuery(".ingredient-groups-enabled").show(),calculateIngredientGroups()}function calculateIngredientGroups(){1==jQuery(".ingredient-group").length?(jQuery("#recipe-ingredients .ingredient .ingredients_group").val(""),jQuery(".ingredient-groups-disabled").show(),jQuery(".ingredient-groups-enabled").hide()):(jQuery("#recipe-ingredients tr.ingredient").each(function(e,n){var t=jQuery(n).prevAll(".ingredient-group:first").find(".ingredient-group-label").val();void 0===t&&(t=jQuery(".ingredient-group-first").find(".ingredient-group-label").val()),jQuery(n).find(".ingredients_group").val(t)}),jQuery(".ingredient-groups-disabled").hide(),jQuery(".ingredient-groups-enabled").show())}function addRecipeInstructionGroup(){var e=jQuery("#recipe-instructions tr.instruction-group-stub"),n=jQuery("#recipe-instructions tr:last");e.clone(!0).insertAfter(n).removeClass("instruction-group-stub").addClass("instruction-group"),jQuery(".instruction-groups-disabled").hide(),jQuery(".instruction-groups-enabled").show(),calculateInstructionGroups()}function calculateInstructionGroups(){1==jQuery(".instruction-group").length?(jQuery("#recipe-instructions .instruction .instructions_group").val(""),jQuery(".instruction-groups-disabled").show(),jQuery(".instruction-groups-enabled").hide()):(jQuery("#recipe-instructions tr.instruction").each(function(e,n){var t=jQuery(n).prevAll(".instruction-group:first").find(".instruction-group-label").val();void 0===t&&(t=jQuery(".instruction-group-first").find(".instruction-group-label").val()),jQuery(n).find(".instructions_group").val(t)}),jQuery(".instruction-groups-disabled").hide(),jQuery(".instruction-groups-enabled").show())}function updateIngredientIndex(){jQuery("#recipe-ingredients tr.ingredient").each(function(e){jQuery(this).find("input").attr("name",function(n,t){return t.replace(/(\d+)/,e)}).attr("id",function(n,t){return t.replace(/(\d+)/,e)})})}function addRecipeIngredient(){var e=jQuery("#recipe-ingredients tr.ingredient").length,n=jQuery("#recipe-ingredients tr:last"),t=jQuery("#recipe-ingredients tr.ingredient:last").clone(!0);t.find("td.ingredient-preview").html(""),t.insertAfter(n).find("input, select, textarea").val("").attr("name",function(n,t){return t.replace(/(\d+)/,e)}).attr("id",function(n,t){return t.replace(/(\d+)/,e)}).closest("tr.ingredient").attr("id",function(n,t){return t.replace(/(\d+)/,e)}),t.find("span.ingredients-delete").show(),jQuery("#recipe-ingredients tr:last .ingredients_amount").focus(),calculateIngredientGroups()}function addRecipeInstruction(){var e=jQuery("#recipe-instructions tr.instruction").length,n=jQuery("#recipe-instructions tr.instruction:last").clone(!0);n.insertAfter("#recipe-instructions tr:last").find("textarea").val("").attr("name",function(n,t){return t.replace(/(\d+)/,e)}).attr("id",function(n,t){return t.replace(/(\d+)/,e)}),n.find(".recipe_instructions_remove_image").addClass("wpurp-hide"),n.find(".recipe_instructions_add_image").removeClass("wpurp-hide"),n.find(".recipe_instructions_thumbnail").val(""),n.find(".recipe_instructions_image").attr("name",function(n,t){return t.replace(/(\d+)/,e)}).attr("id",function(n,t){return t.replace(/(\d+)/,e)}).val(null),n.find(".recipe_instructions_thumbnail").attr("id",function(n,t){return t.replace(/(\d+)/,e)}).attr("src",custom_user_submissions.placeholder),n.find(".instructions_group").attr("name",function(n,t){return t.replace(/(\d+)/,e)}).attr("id",function(n,t){return t.replace(/(\d+)/,e)}),n.find("span.instructions-delete").show(),jQuery("#recipe-instructions tr:last textarea").focus(),calculateInstructionGroups()}function updateInstructionIndex(){jQuery("#recipe-instructions tr.instruction").each(function(e){jQuery(this).find("textarea").attr("name",function(n,t){return t.replace(/(\d+)/,e)}).attr("id",function(n,t){return t.replace(/(\d+)/,e)}),jQuery(this).find(".recipe_instructions_image").attr("name",function(n,t){return t.replace(/(\d+)/,e)}),jQuery(this).find(".instructions_group").attr("name",function(n,t){return t.replace(/(\d+)/,e)}).attr("id",function(n,t){return t.replace(/(\d+)/,e)})})}jQuery(document).ready(function(){jQuery(document).on("input",".ingredients_name",function(){autoSuggestIngredient(jQuery(this))}),jQuery("input.ingredients_name").focusout(function(){spinnerHTML=jQuery(this).closest("td").next().children(".ajax-indicator"),spinnerHTML.css("visibility","hidden");try{xhr.abort()}catch(e){}}),jQuery(document).on("input",".ingredients_unit",function(){autoSuggestUnit(jQuery(this))}),jQuery(document).on("focusin","tr.ingredient",function(){console.log("Focus in on tr.ingredient"),toggleIngredientPreview(this)}),jQuery(document).on("click","tr.ingredient.saved",function(){console.log("Click on tr.ingredient.saved"),jQuery(this).focus()}),jQuery("#wpurp_user_submission_form select").select2({width:"off",dropdownAutoWidth:!1,minimumResultsForSearch:-1,allowClear:!1,templateSelection:function(e,n){var t="";-1==e.element.value&&(t='class="option-none"');return jQuery("<span "+t+">"+e.text+"</span>")}}),jQuery(".select2-search input").prop("readonly",!0),jQuery(".select2, .select2-multiple").on("select2:open",function(e){jQuery(".select2-search input").prop("focus",!1)}),jQuery(".taxonomy-select-boxes").removeClass("nodisplay"),jQuery(".taxonomy-select-spinner").addClass("nodisplay"),jQuery("#insert-recipe-shortcode").on("click",function(){i("[recipe]")}),jQuery("#insert-nutrition-shortcode").on("click",function(){i("[nutrition-label]")});var e,n,t=jQuery("textarea#content");function i(e){if(!tinyMCE.activeEditor||tinyMCE.activeEditor.isHidden()){var n=t.val();t.val(n+e)}else tinyMCE.execCommand("mceInsertContent",!1,e)}jQuery("#recipe-ingredients tr.ingredient:first").find("span.ingredients-delete").hide(),jQuery("#recipe-instructions tr.instruction:first").find("span.instructions-delete").hide(),calculateIngredientGroups(),jQuery("#ingredients-add-group").on("click",function(e){e.preventDefault(),addRecipeIngredientGroup()}),jQuery(".ingredient-group-label").on("input",function(){window.clearTimeout(e),e=window.setTimeout(function(){calculateIngredientGroups()},500)}),jQuery(".ingredient-group-delete").on("click",function(){jQuery(this).parents("tr").remove(),calculateIngredientGroups()}),calculateInstructionGroups(),jQuery("#instructions-add-group").on("click",function(e){e.preventDefault(),addRecipeInstructionGroup()}),jQuery(".instruction-group-label").on("input",function(){window.clearTimeout(n),n=window.setTimeout(function(){calculateInstructionGroups()},500)}),jQuery("#recipe-ingredients tbody").sortable({opacity:.6,revert:!0,cursor:"move",handle:".sort-handle",update:function(){calculateIngredientGroups(),updateIngredientIndex()}}),jQuery(".ingredients-delete").on("click",function(){jQuery(this).parents("tr").remove(),updateIngredientIndex()}),jQuery("#ingredients-add").on("click",function(e){e.preventDefault(),addRecipeIngredient()}),jQuery("#recipe-ingredients .ingredients_notes").on("keydown",function(e){var n=e.keyCode||e.which,t=jQuery("#recipe-ingredients tr:last").attr("id"),i=jQuery(this).closest("tr.ingredient"),r=i.attr("id");9==n&&0==e.shiftKey&&(e.preventDefault(),r==t?addRecipeIngredient():i.next().focus())}),jQuery("#recipe-ingredients .ingredients_amount").on("keydown",function(e){var n=e.keyCode||e.which,t=(jQuery("#recipe-ingredients tr:last").attr("id"),jQuery(this).closest("tr.ingredient")),i=t.attr("id");if(console.log("Current ingredient : "+i),9==n&&1==e.shiftKey){event.preventDefault();var r=t.prev();r.focus();r.attr("id")}}),jQuery("#recipe-instructions tbody").sortable({opacity:.6,revert:!0,cursor:"move",handle:".sort-handle",update:function(){calculateInstructionGroups(),updateInstructionIndex()}}),jQuery(".instructions-delete").on("click",function(){jQuery(this).parents("tr").remove(),updateInstructionIndex()}),jQuery("#instructions-add").on("click",function(e){e.preventDefault(),addRecipeInstruction()}),jQuery(".recipe_thumbnail_add_image").on("click",function(e){e.preventDefault();var n=jQuery(this);if(image=n.siblings(".recipe_thumbnail_image"),preview=n.siblings(".recipe_thumbnail"),"function"==typeof wp.media)var t=wp.media({title:"Insert Media",button:{text:"Add featured image"},multiple:!1}).on("select",function(){var e=t.state().get("selection").first().toJSON();jQuery(preview).attr("src",e.url),jQuery(image).val(e.id).trigger("change")}).open();else post_id=n.attr("rel"),tb_show(n.attr("value"),"wp-admin/media-upload.php?post_id="+post_id+"&type=image&TB_iframe=1"),window.send_to_editor=function(e){img=jQuery("img",e),imgurl=img.attr("src"),classes=img.attr("class"),id=classes.replace(/(.*?)wp-image-/,""),image.val(id).trigger("change"),preview.attr("src",imgurl),tb_remove()}}),jQuery(".recipe_thumbnail_remove_image").on("click",function(e){e.preventDefault();var n=jQuery(this);n.siblings(".recipe_thumbnail_image").val("").trigger("change"),n.siblings(".recipe_thumbnail").attr("src",wpurp_recipe_form.coreUrl+"/img/image_placeholder.png")}),jQuery(".recipe_thumbnail_image").on("change",function(){var e=jQuery(this);""==e.val()?(e.siblings(".recipe_thumbnail_add_image").removeClass("wpurp-hide"),e.siblings(".recipe_thumbnail_remove_image").addClass("wpurp-hide")):(e.siblings(".recipe_thumbnail_remove_image").removeClass("wpurp-hide"),e.siblings(".recipe_thumbnail_add_image").addClass("wpurp-hide"))}),jQuery(".recipe-instructions-container").on("change","input.recipe_instructions_image",function(){PreviewImage(jQuery(this).attr("id").match(/\d+/))}),jQuery("#wpurp-insert-recipe").on("click",function(){var e="[ultimate-recipe id=";e+=jQuery("#wpurp-recipe").find("option:selected").val(),e+="]",tinyMCE.activeEditor.execCommand("mceInsertContent",0,e),tinyMCE.activeEditor.windowManager.close()}),jQuery(".wpurp-file-remove").on("click",function(e){e.preventDefault();var n=jQuery(this);preview=n.siblings("img"),fieldname=preview.attr("class"),n.siblings("."+fieldname+"_image").val(""),n.siblings("."+fieldname).attr("src",""),n.siblings(".wpurp-file-upload").removeClass("wpurp-hide"),n.addClass("wpurp-hide")})}),jQuery(".instruction-group-delete").on("click",function(){jQuery(this).parents("tr").remove(),calculateInstructionGroups()});